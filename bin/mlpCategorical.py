# -*- coding: utf-8 -*-
"""
Created on Thu Mar 25 08:52:42 2021

@author: optimus
"""


class MLPCategorical(nn.Module):
    """
    MLPCategorical stitches together a categorical distribution on top of an MLP,
    so that the final layer of the MLP are used as logits to parametrise the categorical distribution.
    """
    def __init__(self, mlpInputLength, logitsLength, hiddenLayersLengths, intemediateActivation = nn.Identity(), outputActivation = nn.Identity()):
        super().__init__()
        self.logitsNetwork = explicitMLP(mlpInputLength, logitsLength, hiddenLayersLengths, intemediateActivation, outputActivation)
        
        
    def _generateDistribution(self, observation):
        """
        A function to create a parametrised distribution
        
        Parameters
        ----------
        observation : a valid input to the model defined by the explicitMLP of the class.
            This doesn't have to be THE observation from the environment, it's just a borrowed name.

        Returns
        -------
        result : A categorical distribution.
            A categorical distribution over k, where 0 <= k < len(logitsLength) parametrised logits that were generated by an MLP.

        """
        logitsValue = self.logitsNetwork(observation)
        result = Categorical(logits=logitsValue)
        return result
    
    def _logProbabilitiesFromDistribution(self, categoricalDistribution, action):
        result = categoricalDistribution.log_prob(action).sum(axis = -1)
        return result
        
        
        
    def forward(self, observation, action = None):
        """
        Produce a categorical distribution.
        If action is given then compute their log likelihood of under the distribution produced.
        Parameters
        ----------
        observation : TYPE
            DESCRIPTION.
        action : TYPE, optional
            DESCRIPTION. The default is None.

        Returns
        -------
        categoricalDistribution : a categorical distribution
        logLikelihood : log likelihood of action if given. None otherwise.

        """
        
        logLikelihood = None
        categoricalDistribution = self._generateDistribution(observation)
        if action is not None:
            #Omer Sella: TODO: I'm using log probabilities to make log likelihood - doesn't look good.
            logLikelihood = self._logProbabilitiesFromDistribution(categoricalDistribution, action)
        return categoricalDistribution, logLikelihood
    